<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Reserva - Hotel Casanova</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-black mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">üè® HOTEL CASANOVA</a>
        </div>
    </nav>

    <div class="container mb-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-lg border-0 rounded-4">
                    <div class="card-header bg-warning text-dark text-center py-3">
                        <h4 class="mb-0 fw-bold">Finalizar Reserva</h4>
                    </div>
                    <div class="card-body p-5">
                        
                        <div id="loading" class="text-center">
                            <div class="spinner-border text-warning" role="status"></div>
                            <p>Verificando usuario...</p>
                        </div>

                        <form action="/api/reservar" method="POST" id="formReserva" style="display:none;">
                            
                            <h5 class="mb-3 border-bottom pb-2">1. Tu Habitaci√≥n</h5>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Habitaci√≥n Seleccionada</label>
                                <!-- El select usa el evento 'change' para recalcular el precio si el usuario cambia de opini√≥n -->
                                <select class="form-select bg-light" id="tipoHabitacion" name="tipo_habitacion">
                                    <option value="cinema">üé¨ Suite Cinema ($150)</option>
                                    <option value="switch">üéÆ Room Switch ($120)</option>
                                    <option value="ps5">üïπÔ∏è Gamer Pro PS5 ($200)</option>
                                    <option value="suite">ü•Ç Suite Casanova ($250)</option>
                                    <option value="xbox">üíö Xbox Lounge ($130)</option>
                                    <option value="retro">üëæ Retro Arcade ($100)</option>
                                    <option value="matrimonial">‚ù§Ô∏è Matrimonial ($140)</option>
                                    <option value="familiar">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familiar ($180)</option>
                                </select>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Check-In</label>
                                    <input type="date" class="form-control" id="checkin" name="checkin" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Check-Out</label>
                                    <input type="date" class="form-control" id="checkout" name="checkout" required>
                                </div>
                            </div>

                            <!-- ZONA DE C√ÅLCULO EN VIVO -->
                            <div class="card bg-light border-primary mb-4">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">Estancia:</small><br>
                                        <strong><span id="spanDias">0</span> Noches</strong>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">Total a Pagar:</small><br>
                                        <span class="fs-3 fw-bold text-primary">$<span id="spanTotal">0.00</span></span>
                                    </div>
                                </div>
                            </div>

                            <h5 class="mb-3 border-bottom pb-2">2. Tus Datos</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Nombre</label>
                                    <input type="text" class="form-control" id="clienteNombre" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Tel√©fono</label>
                                    <input type="text" class="form-control" id="clienteTelefono" readonly>
                                </div>
                            </div>

                            <h5 class="mb-3 border-bottom pb-2 mt-4">3. Pago</h5>
                            <div class="mb-3">
                                <label class="form-label fw-bold">M√©todo de Pago</label>
                                <select class="form-select" name="metodo_pago" required>
                                    <option value="" selected disabled>Elige una opci√≥n...</option>
                                    <option value="tarjeta">üí≥ Tarjeta de Cr√©dito/D√©bito</option>
                                    <option value="yape">üü£ Yape / Plin</option>
                                    <option value="efectivo">üíµ Efectivo en Recepci√≥n</option>
                                </select>
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-dark btn-lg fw-bold">CONFIRMAR RESERVA</button>
                                <a href="/" class="btn btn-outline-secondary">Cancelar</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // DICCIONARIO DE PRECIOS (M√°s seguro y f√°cil de mantener)
            const preciosPorHabitacion = {
                'cinema': 150,
                'switch': 120,
                'ps5': 200,
                'suite': 250,
                'xbox': 130,
                'retro': 100,
                'matrimonial': 140,
                'familiar': 180
            };

            // 1. Verificar Login
            fetch('/api/usuario_actual')
                .then(r => r.status === 401 ? window.location.href = "/login" : r.json())
                .then(user => {
                    if(user) {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('formReserva').style.display = 'block';
                        document.getElementById('clienteNombre').value = user.nombre_completo;
                        document.getElementById('clienteTelefono').value = user.telefono;
                    }
                });

            // 2. Preseleccionar Habitaci√≥n desde la URL (ej: ?tipo=ps5)
            const params = new URLSearchParams(window.location.search);
            const tipoUrl = params.get('tipo');
            
            if (tipoUrl && preciosPorHabitacion[tipoUrl]) {
                document.getElementById('tipoHabitacion').value = tipoUrl;
            }

            // 3. L√ìGICA DE C√ÅLCULO
            const inInput = document.getElementById('checkin');
            const outInput = document.getElementById('checkout');
            const roomSelect = document.getElementById('tipoHabitacion');
            
            function calcular() {
                const fechaIn = new Date(inInput.value);
                const fechaOut = new Date(outInput.value);
                const tipoActual = roomSelect.value;
                const precioBase = preciosPorHabitacion[tipoActual] || 0;

                // Validar que ambas fechas existan y que la salida sea posterior a la entrada
                if(inInput.value && outInput.value && fechaOut > fechaIn) {
                    const diffTime = Math.abs(fechaOut - fechaIn);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    
                    document.getElementById('spanDias').innerText = diffDays;
                    document.getElementById('spanTotal').innerText = (diffDays * precioBase).toFixed(2);
                } else {
                    document.getElementById('spanDias').innerText = "0";
                    document.getElementById('spanTotal').innerText = "0.00";
                }
            }

            // Escuchar cambios en fechas Y en el tipo de habitaci√≥n
            inInput.addEventListener('input', calcular);
            outInput.addEventListener('input', calcular);
            roomSelect.addEventListener('change', calcular);
            
            // Ejecutar una vez al inicio por si acaso hay datos prellenados
            calcular();
        });
    </script>
</body>
</html>